<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><title>: Improving Android Build Performance</title><meta content="yes" name="apple-mobile-web-app-capable" /><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style" /><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui" name="viewport" /><link href="reveal.js/css/reveal.css" rel="stylesheet" /><link rel="stylesheet" href="reveal.js/css/theme/gradle.css" id="theme" /><!--This CSS is generated by the Asciidoctor-Reveal.js converter to further integrate AsciiDoc's existing semantic with Reveal.js--><style type="text/css">.reveal div.right {
  float: right;
}

/* callouts */
.conum[data-value] {display:inline-block;color:#fff!important;background-color:rgba(50,150,50,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}</style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" /><link href="reveal.js/lib/css/zenburn.css" rel="stylesheet" /><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "reveal.js/css/print/pdf.css" : "reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><!--[if lt IE 9]><script src="reveal.js/lib/js/html5shiv.js"></script><![endif]-->
<link rel="stylesheet" type="text/css" href="reveal.js/css/theme/asciinema-player.css" />
<link rel="stylesheet" type="text/css" href="reveal.js/css/theme/asciinema-theme-gradle.css" />
<link rel="stylesheet" type="text/css" href="reveal.js/css/theme/github-gist.css" />
<script src="reveal.js/css/theme/asciinema-player.js"></script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title" data-transition="zoom" data-transition-speed="fast" data-background-image="./images/title.jpeg"><h1></h1><h2>Improving Android Build Performance</h2><div class="preamble"><div class="paragraph"><p><h2>
Droidcon Berlin 2019
</h2></p></div>
<div class="paragraph"><p>Volker Leck (@devisnik) - Gradle Inc.</p></div>
<aside class="notes"><div class="paragraph"><p>Welcome, everybody!</p></div>
<div class="paragraph"><p>Let&#8217;s talk about Android Build performance.</p></div>
<div class="paragraph"><p>We all heard that the Android build system is based on Gradle.
And we&#8217;ll look into the mechanics of that quite bit in this this talk.</p></div>
<div class="paragraph"><p>So what is Gradle?</p></div></aside></div></section>
<section><section id="what-is-gradle"><h2>What is Gradle?</h2><aside class="notes"><div class="paragraph"><p>We all heard that the Android build system is based on Gradle.
And we&#8217;ll look into the mechanics of that quite bit in this this talk.</p></div>
<div class="paragraph"><p>So what is Gradle?</p></div></aside></section><section id="gradle-org"><h2>Gradle.org</h2><div class="paragraph"><p>Gradle is a build and automation tool.</p></div>
<div class="openblock small"><div class="content"><div class="ulist"><ul><li><p>agnostic Build System</p></li><li><p>100% Free Open Source - Apache Standard License 2.0</p><div class="ulist"><ul><li><p>JVM based</p></li><li><p>Multi-ecosystem</p><div class="ulist"><ul><li><p>JVM: Java, Kotlin, Groovy, Scala, &#8230;&#8203;</p></li><li><p>Native: C/C++, Go, &#8230;&#8203;</p></li><li><p>Android</p></li><li><p>&#8230;&#8203;</p></li></ul></div></li></ul></div></li></ul></div></div></div>
<aside class="notes"><div class="paragraph"><p>Gradle is not "the Android build system", but an agnostic Build system&#8230;&#8203;.</p></div>
<div class="paragraph"><p>Can be adopted to many different build ecosystems.</p></div>
<div class="paragraph"><p>Some years ago Android Buildtools team decided to base the Android build system on Gradle,
providing the "Android Gradle plugin".</p></div>
<div class="paragraph"><p>That plugin adapts Gradle to build Android projects.</p></div>
<div class="paragraph"><p>We work closely with to improve performance with every new release.</p></div></aside></section><section id="gradle-inc"><h2>Gradle Inc.</h2><div class="paragraph"><p>The company behind Gradle.</p></div>
<div class="ulist"><ul><li><p>Builds Happiness</p></li><li><p>Employs full time engineers</p></li><li><p>Provides Gradle Build Scans and Gradle Enterprise</p></li><li><p>Consulting and Training</p></li></ul></div>
<div class="openblock small"><div class="content"><div class="ulist"><ul><li><p><a href="https://gradle.com/training/" class="bare">https://gradle.com/training/</a></p></li><li><p><a href="https://gradle.com/blog/tag/webcast/" class="bare">https://gradle.com/blog/tag/webcast/</a></p></li></ul></div></div></div></section></section>
<section><section id="the-cost-of-builds"><h2>The Cost of Builds</h2><aside class="notes"><div class="paragraph"><p>Why do we even care about build performance?</p></div></aside></section><section id="fast-builds-matter"><h2>Fast builds matter</h2><div class="paragraph"><p>30 seconds waste * 50 builds * 10 developers</p></div>
<div class="paragraph"><p>&gt; 4 hours wasted time per day</p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Just do the math!</p></li><li><p>&#8230;&#8203;not even considering lost focus</p></li><li><p>When the build is slow:</p><div class="ulist"><ul><li><p>people start building less (work in larger increments instead), getting less early feedback,</p></li><li><p>issues arise late</p></li><li><p>more failure on CI.</p></li></ul></div></li></ul></div></aside></section><section id="build-engineer"><h2>Build engineer</h2><div class="ulist"><ul><li><p>monitors build</p></li><li><p>ensures build health</p></li><li><p>fixes regressions</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>answers questions like:</p></div>
<div class="ulist"><ul><li><p>How many builds are run locally and on CI?</p></li><li><p>How often do they fail? And for which reasons?</p></li><li><p>What are the longest-running tasks?</p></li><li><p>Which tasks are run most often?</p></li><li><p>Has our build become slower/faster lately?</p></li><li><p>By how much?</p></li><li><p>Which parts are affected?</p></li><li><p>Which tests are slow? Which are flaky?</p></li></ul></div></aside></section><section id="build-engineering"><h2>Build engineering</h2><div class="quoteblock"><blockquote><div class="paragraph"><p>In a healthy culture, developers and engineering leaders understand that the domain
of <strong>building and integrating</strong> software is just as <strong>complex and challenging</strong> as the domain
of application development.</p></div></blockquote><div class="attribution">&#8212; Hans Dockter, Founder and CEO of Gradle Inc.</div></div>
<div class="paragraph"><p><a href="https://gradle.com/blog/build-engineer-challenges/" class="bare">https://gradle.com/blog/build-engineer-challenges/</a></p></div></section></section>
<section><section id="where-is-the-problem"><h2>Where is the problem?</h2><aside class="notes"><div class="paragraph"><p>We can not just jump into the build and fix some random finding.</p></div>
<div class="paragraph"><p>To tackle performance issues, we need a more rigid and scientific approach.</p></div></aside></section><section id="process"><h2>Process</h2><div class="olist arabic"><ol class="arabic"><li><p>define scenario to improve</p></li><li><p>profile it</p></li><li><p>identify biggest bottleneck</p></li><li><p>fix it</p></li><li><p>verify (by measurement)</p></li></ol></div>
<aside class="notes"><div class="paragraph"><p>To explore performance issues we have a process to follow.</p></div>
<div class="paragraph"><p>You need to decide what you want to improve.</p></div>
<div class="paragraph"><p>sample scenarios:</p></div>
<div class="ulist"><ul><li><p>Android studio sync time</p></li><li><p>single line change triggers long-running build</p></li><li><p>developers complain about slow test execution</p></li></ul></div>
<div class="paragraph"><p>Often you see multiple things to improve, but focus on the biggest issue.</p></div>
<div class="paragraph"><p>Verification is absolutely needed.
Often we see people just assuming a fix works!</p></div>
<div class="paragraph"><p>We follow this process at Gradle to improve performance!</p></div></aside></section><section id="automate-your-measurements"><h2>Automate your measurements</h2><pre class="highlight listingblock"><code data-noescape="" class="bash language-bash">check-no-tests {
    tasks = ["check"]
    gradle-args = ["-x", "test"]
    cleanup-tasks = ["clean"]
    warm-ups = 2
}
androidStudioSync {
    android-studio-sync { }
}</code></pre>
<div class="paragraph"><p><a href="https://github.com/gradle/gradle-profiler" class="bare">https://github.com/gradle/gradle-profiler</a></p></div>
<aside class="notes"><div class="paragraph"><p>When you&#8217;re serious about performance, you absolutely want to automate all your measurements.</p></div>
<div class="paragraph"><p>Gradle Profiler is a tool to automate the gathering of profiling and benchmarking information
for Gradle builds.</p></div>
<div class="ulist"><ul><li><p>runs pre-defined scenarios &#8594; see examples</p></li><li><p>can produce all kinds of profiling outputs, including Build scans</p></li></ul></div>
<div class="paragraph"><p>Used internally within Gradle. You can send us a profile if your experiencing issue an we can
look ay it.</p></div></aside></section></section>
<section><section id="general-advice"><h2>General Advice</h2><aside class="notes"><div class="paragraph"><p>Before we start looking into specific findings, let me give some general advice.</p></div></aside></section><section id="stay-up-to-date"><h2>Stay up-to-date</h2><div class="paragraph"><p><code>./gradlew wrapper --gradle-version 5.5</code></p></div>
<div class="paragraph"><p><a href="https://services.gradle.org/versions/current" class="bare">https://services.gradle.org/versions/current</a></p></div>
<div class="paragraph"><p> </p></div>
<div class="title">build.gradle</div><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">classpath 'com.android.tools.build:gradle:3.4.1'</code></pre>
<aside class="notes"><div class="paragraph"><p>There is <strong>performance improvements</strong> and <strong>bug fixes</strong> coming with every new release.</p></div>
<div class="paragraph"><p>Gradle releases every 6 to 8 weeks.</p></div>
<div class="paragraph"><p>AGP is updated a bit less frequently.</p></div></aside></section><section id="settings"><h2>Settings</h2><div class="paragraph"><p><code>org.gradle.jvmargs=-Xmx4G</code></p></div>
<div class="paragraph"><p><code>org.gradle.daemon = true</code></p></div>
<div class="openblock small"><div class="content"><div class="paragraph"><p><code>org.gradle.caching = true</code></p></div>
<div class="paragraph"><p><code>org.gradle.parallel = true</code></p></div></div></div>
<aside class="notes"><div class="paragraph"><p>jvmargs:</p></div>
<div class="paragraph"><p>You might see some post on stack overflow advising "just past these 20 parameters into your jvmargs".
Don&#8217;t do that!</p></div>
<div class="ulist"><ul><li><p>just provide enough heap space</p></li><li><p>other tweaks often do harm,</p></li><li><p>time is better spent on structural improvements</p></li></ul></div>
<div class="paragraph"><p>daemon:</p></div>
<div class="ulist"><ul><li><p>ON by default, Do not disable it!</p></li><li><p>in-memory caches</p></li><li><p>when building repeatedly</p></li><li><p>builds get faster over time due to JIT and in-memory caching</p></li></ul></div>
<div class="paragraph"><p>If you need to disable the daemon for whatever reason, there is a problem in your build you need to fix.</p></div>
<div class="paragraph"><p>At Gradle, we even run CI builds with enabled daemon.</p></div>
<div class="paragraph"><p>You set those in <code>gradle.properties</code> in the root project</p></div>
<div class="paragraph"><p>Settings for all your builds go into the <code>gradle.properties</code> of your GRADLE_HOME folder.</p></div>
<div class="paragraph"><p>You probably want to enable caching and parallel builds as well.
We&#8217;ll look into the details of those later.</p></div></aside></section><section id="repository-content-filtering"><h2>Repository content filtering</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">google() {
    content {
	    includeGroupByRegex "com\\.android\\..*"
	    includeGroupByRegex "com\\.google\\.android\\..*"
	    includeGroupByRegex "androidx\\..*"
    }
}</code></pre>
<div class="openblock small"><div class="content"><div class="paragraph"><p><a href="https://docs.gradle.org/current/userguide/declaring_repositories.html#declaring_a_repository_filter" class="bare">https://docs.gradle.org/current/userguide/declaring_repositories.html#declaring_a_repository_filter</a></p></div></div></div>
<aside class="notes"><div class="paragraph"><p>A lot of work at Gradle has gone into improving dependency management, lately.</p></div>
<div class="paragraph"><p>There is a dedicated team working on that.</p></div>
<div class="paragraph"><p>One of things added is <strong>Repository content filter</strong>.</p></div>
<div class="paragraph"><p>Allows to specify which dependencies to expect from a repository.</p></div>
<div class="paragraph"><p>Repositories are searched in the order they are defined, and usually <code>google()</code> has to be
defined first. (There was an issue with play services forcing that ordering.)</p></div>
<div class="paragraph"><p>Great too for repositories that only provide a single or very few dependencies.
(jitpack, your custom repo, fabrics repo, &#8230;&#8203;)</p></div>
<div class="paragraph"><p>Reasons:</p></div>
<div class="ulist"><ul><li><p>performance, when you know a dependency will never be found in a specific repository</p></li><li><p>security, by avoiding leaking what dependencies are used in a private project</p></li><li><p>reliability, when some repositories contain corrupted metadata or artifacts</p></li></ul></div>
<div class="paragraph"><p>It’s even more important when considering that order of repositories matter.</p></div></aside></section></section>
<section><section id="build-lifecycle"><h2>Build Lifecycle</h2><aside class="notes"><div class="paragraph"><p>Once our measurements and profiling is done, we need good way to <strong>visualize</strong>
what has actually happened in the profiled build.</p></div>
<div class="paragraph"><p>And the best tool for that job is <strong>Build Scans</strong>.</p></div></aside></section><section id="build-scans"><h2>Build Scans</h2><div class="imageblock" style=""><img src="./images/build-scan-overview.png" alt="Build Scan Overview" width="1100" height="500" /></div>
<div class="paragraph"><p><code>./gradlew --scan</code> &#160;&#160;&#160;&#160;&#160;&#160;  <a href="http://scans.gradle.com" class="bare">http://scans.gradle.com</a></p></div>
<aside class="notes"><div class="paragraph"><p>Who has used build scans before?</p></div>
<div class="paragraph"><p>Who uses it regularly?</p></div>
<div class="paragraph"><p>How does it work? Just add <code>--scan</code> and your provided with a link to scan at the end of the build.</p></div>
<div class="ulist"><ul><li><p>free service provided by Gradle Inc.</p></li><li><p>shareable, persistent record of a build</p></li><li><p>provides insights into what happened and why</p></li><li><p>user-friendly and insightful</p></li><li><p>completely free</p></li><li><p>supports Gradle and Maven builds</p></li><li><p>deep links to any of the details</p></li><li><p>to be shared with your colleagues</p></li><li><p>only accessible via a randomly generated link</p></li></ul></div>
<div class="paragraph"><p>Google loves these build scans too.</p></div></aside></section><section id="build-lifecycle-2"><h2>Build Lifecycle</h2><div class="imageblock" style=""><img src="./images/scan-performance.png" alt="the build lifecycle" width="1100" height="500" /></div>
<aside class="notes"><div class="paragraph"><p>Here we look into the performance section of a build scan.</p></div>
<div class="ulist"><ul><li><p>detailed listing of how much time was spent in certain parts of the build</p></li></ul></div>
<div class="paragraph"><p>3 Phases</p></div>
<div class="ulist"><ul><li><p>initialization: startup, run buildSrc project, read settings</p></li><li><p>configuration: Gradle makes sense of your build</p></li><li><p>execution: Gradle runs the requested tasks (and all the tasks that need to run before them)</p></li></ul></div>
<div class="paragraph"><p>We&#8217;ll look at each of these phases separately.</p></div>
<div class="paragraph"><p>Gradle and Android Gradle plugin do lots of optimizations to keep the build fast.</p></div>
<div class="paragraph"><p>But Gradle is also very flexible, and there are many opportunities to shoot yourself in the foot.</p></div></aside></section><section id="high-gc-time"><h2>High GC time</h2><div class="imageblock" style=""><img src="./images/high-gc-time.png" alt="high gc time" width="*" height="500" /></div>
<aside class="notes"><div class="paragraph"><p>Sometimes the problem is pretty easy to spot!</p></div>
<div class="paragraph"><p>Here we see a build with a high time spent on garbage collection.</p></div></aside></section><section id="high-gc-time-fixed"><h2>High GC time (fixed)</h2><div class="imageblock" style=""><img src="./images/high-gc-time-fixed.png" alt="high gc time fixed" width="*" height="500" /></div></section><section id="red-flags"><h2>Red flags</h2><div class="ulist"><ul><li><p>initialization &gt; 1s</p></li><li><p>long configuration</p></li><li><p>single line change <code>~=</code> clean build</p></li><li><p>high gc time</p></li></ul></div>
<aside class="notes"><div class="ulist"><ul><li><p>Startup/Settings/buildSrc being slow</p><div class="ulist"><ul><li><p>daemon enabled? Healthy?</p></li><li><p>dedicated section in the build scans</p></li><li><p>might have a memory leak</p></li></ul></div></li><li><p>configuration</p><div class="ulist"><ul><li><p>dependent on your build</p></li><li><p>previous scan configuration took 1.4 seconds, 20 sub-projects, 100.000 lines of code, mixed kotlin/java</p></li></ul></div></li><li><p>single line change</p><div class="ulist"><ul><li><p>Gradle supports incremental compilation</p></li><li><p>should only re-build what has changed and their dependants</p></li></ul></div></li></ul></div></aside></section><section id="logic-during-initialization"><h2>Logic during initialization</h2><div class="paragraph"><p>Don&#8217;t do this!</p></div>
<pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">// logic in settings.gradle
// brittle, can be slow!

new File('.').eachFileRecurse(groovy.io.FileType.DIRECTORIES) { dir -&gt;
    if (new File(dir,"build.gradle").exists()) {
        def name = dir.toString()[1..-1].replaceAll('/',':')
        include name
    }}</code></pre>
<aside class="notes"><div class="paragraph"><p>Someone tried to be clever!</p></div>
<div class="ulist"><ul><li><p>code traverses the project file tree to find all subprojects automatically,
avoiding adding an <code>include</code> line for each new subproject</p></li><li><p>this is <strong>expensive</strong></p></li><li><p>dependent on file system layout</p></li><li><p>incurs hidden performance penalty</p></li><li><p>clever, but brittle!</p></li></ul></div></aside></section><section id="configuration"><h2>Configuration</h2><div class="ulist"><ul><li><p>Evaluating build scripts</p></li><li><p>Applying plugins</p></li><li><p>Running <code>afterEvaluate {}</code> blocks</p></li></ul></div>
<aside class="notes"></aside></section><section id="when"><h2>When?</h2><div class="ulist"><ul><li><p>on any Gradle run</p></li><li><p>Even <code>./gradlew help</code> or <code>./gradlew tasks</code></p></li><li><p>Android Studio sync</p></li></ul></div></section><section id="slow-plugin"><h2>Slow plugin</h2><div class="imageblock" style=""><img src="./images/slow-plugin-configuration.png" alt="slow plugin application" width="1100" height="*" /></div>
<div class="paragraph"><p>Be aware of inefficient plugins!</p></div></section><section id="resolution-at-configuration-time"><h2>Resolution at configuration time</h2><div class="imageblock" style=""><img src="./images/resolution-at-configuration.png" alt="eager dependency resolution" width="1100" height="*" /></div>
<div class="paragraph"><p>Avoid Dependency resolution at configuration time!</p></div>
<aside class="notes"><div class="paragraph"><p>Can happen easily!</p></div>
<div class="paragraph"><p>So common, build scan warns about it in "Performance &gt; Settings &amp; Suggestions".</p></div></aside></section><section id="eager-resolution"><h2>Eager Resolution</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">task fatJar(type: Jar) {
    from configurations.runtime.collect {
        it.isDirectory() ? it : zipTree(it)
    }
    with jar
    classifier = 'fat-jar'
}</code></pre>
<aside class="notes"><div class="paragraph"><p>" <code>configurations.runtime.collect</code> triggers dependency resolution
* this is expensive
* fortunately, the fix is simple</p></div></aside></section><section id="lazy-resolution"><h2>Lazy Resolution</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">task fatJar(type: Jar) {
    from {
        configurations.runtime.collect {
            it.isDirectory() ? it : zipTree(it)
        }
    }
    with jar
    classifier = 'fat-jar'
}</code></pre>
<aside class="notes"><div class="ulist"><ul><li><p>pass an action that the task can run when needed instead of the resolved dependencies</p></li></ul></div></aside></section><section id="configuration-avoidance"><h2>Configuration Avoidance</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">tasks.register("fatJar", Jar) {
    from configurations.runtimeClasspath.elements.map {
        it.isDirectory() ? it : zipTree(it)
    }
    with jar
    classifier = 'fat-jar'
}</code></pre>
<div class="paragraph"><p><a href="https://docs.gradle.org/current/userguide/task_configuration_avoidance.html" class="bare">https://docs.gradle.org/current/userguide/task_configuration_avoidance.html</a>
<a href="https://blog.gradle.org/preview-avoiding-task-configuration-time" class="bare">https://blog.gradle.org/preview-avoiding-task-configuration-time</a></p></div>
<aside class="notes"><div class="paragraph"><p>New APIs for Task configuration Avoidance and Lazy Configuration</p></div>
<div class="paragraph"><p>Easy to fix but hard to find. Build scans help!</p></div></aside></section><section id="i-o-at-configuration-time"><h2>I/O at configuration time</h2><div class="imageblock" style=""><img src="./images/task-runs-at-configuration.png" alt="expensive configuration" width="1100" height="*" /></div>
<div class="paragraph"><p>That build script seems expensive</p></div>
<aside class="notes"><div class="paragraph"><p>Gradle puts a lot of effort into avoiding IO at configuration time.
(don&#8217;t touch unchanged scripts, don&#8217;t recompile them, in memory caches in the daemon.)</p></div>
<div class="paragraph"><p>In above scan we see a suspiciously long configuration time for the stats script.</p></div></aside></section><section id="i-o-at-configuration-time-2"><h2>I/O at configuration time</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">task projectStats {
    def statsFile = new File(buildDir, 'stats.txt')
    statsFile.parentFile.mkdirs()
    def javaFiles = sourceSets.main.java.size()
    def javaSize = sourceSets.main.java
	.collect{it.text.bytes}
	.flatten()
	.sum()
    statsFile.text = """
    |SourceFiles:  ${javaFiles}
    |Source size:  ${javaSize} bytes
    """.stripMargin()
}</code></pre>
<div class="paragraph"><p>Careful with custom tasks!</p></div>
<aside class="notes"><div class="ulist"><ul><li><p>A a custom task that creates a files containing some project statistics</p></li></ul></div>
<div class="paragraph"><p>So, what is wrong here?</p></div>
<div class="ulist"><ul><li><p>the file is created during task definition</p></li><li><p><code>doLast {}</code> is missing</p></li></ul></div></aside></section><section id="i-o-at-configuration-time-3"><h2>I/O at configuration time</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">task projectStats {
    def statsFile = new File(buildDir, 'stats.txt')
    input.files sourceSet.main.java
    outputs.file statsFile
    doLast {
        statsFile.parentFile.mkdirs()
        def javaFiles = sourceSets.main.java.size()
        def javaSize = sourceSets.main.java
        	.collect{it.text.bytes}
        	.flatten()
        	.sum()
        statsFile.text = """
        |SourceFiles:  ${javaFiles}
        |Source size:  ${javaSize} bytes
        """.stripMargin()
    }
}</code></pre>
<div class="paragraph"><p>Don&#8217;t forget <code>doLast{}</code></p></div>
<aside class="notes"><div class="paragraph"><p>Fixes the problem, but best practise is to create a separate task class.</p></div></aside></section><section id="i-o-at-configuration-time-4"><h2>I/O at configuration time</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">task projectStats(type: ProjectStats) {
    statsFile = new File(buildDir, 'stats.txt')
    sources = sourceSet.main.java
}

class ProjectStats extends DefaultTask {
    @InputFiles FileCollection sources
    @OutputFile File statsFile

    @TaskAction def stats() {
      statsFile.text = """
      |Files: ${sources.size()}
      |Total: ${sources.collect{it.text.bytes}.flatten().sum()} bytes
      """.stripMargin()
    }
}</code></pre>
<aside class="notes"><div class="paragraph"><p>Create a custom task class to model what the task is doing.
"doLast{}" is not an issue with those then.</p></div>
<div class="paragraph"><p>Properly declare the tasks inputs and outputs.</p></div>
<div class="paragraph"><p>Class can be put into the buildSrc directory.
Keeps your build logic clean.</p></div>
<div class="paragraph"><p>Can be compiled statically.</p></div></aside></section><section id="inefficient-plugins"><h2>Inefficient Plugins</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">// version.gradle
def out = new ByteArrayOutputStream()
exec {
    commandLine 'git','rev-parse','HEAD'
    standardOutput = out
    workingDir = rootDir
}
version = new String(out.toByteArray())

// root 'build.gradle'
allprojects {
    apply from:'$rootDir/version.gradle'
}</code></pre>
<aside class="notes"><div class="paragraph"><p>Who does the code do:</p></div>
<div class="paragraph"><p>in the script <code>version.gradle</code></p></div>
<div class="ulist"><ul><li><p>executes a git command to determine the latest git commit hash.</p></li><li><p>sets the hash as the project&#8217;s version</p></li></ul></div>
<div class="paragraph"><p>in <code>build.gradle</code></p></div>
<div class="ulist"><ul><li><p>script <code>version.gradle</code> is applied to all the sub-projects</p></li></ul></div>
<div class="paragraph"><p>That means the git execution is <strong>run for every sub-module again</strong>.</p></div></aside></section><section id="re-use-expensive-logic"><h2>Re-use expensive logic</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">// root 'build.gradle'
apply from:"$rootDir/version.gradle"

subprojects {
    version = rootProject.version
}</code></pre>
<aside class="notes"><div class="paragraph"><p>Re-use the computed git hash in sub-projects, instead of recomputing.</p></div>
<div class="paragraph"><p>BTW: There is a plugin that does it, no need to do it yourself.</p></div>
<div class="paragraph"><p><a href="https://github.com/palantir/gradle-git-version" class="bare">https://github.com/palantir/gradle-git-version</a></p></div></aside></section><section id="variant-explosion"><h2>Variant explosion</h2><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">variantFilter { variant -&gt;
    def flavorName = variant.flavors[0].name
    def devFlavor = flavorName == 'dev'
    if(!devFlavor &amp;&amp; variant.buildType.name == 'release') {
        variant.ignore = true
    }
}</code></pre>
<aside class="notes"><div class="paragraph"><p>Android allows for rich buildType and flavor definitions.</p></div>
<div class="paragraph"><p>This quickly leads to lots of build variants, which need to be configured.</p></div>
<div class="paragraph"><p>Filter out combinations that are not used.</p></div>
<div class="paragraph"><p>For example, you might have a <code>dev</code> flavor as recommended by Google to
speed up builds during development.</p></div>
<div class="paragraph"><p>(i.e. to run without shrinking when minSdk is normally &lt; 21 and debug apk &gt; 64k)</p></div>
<div class="paragraph"><p><a href="https://developer.android.com/studio/build/multidex#mdex-on-l" class="bare">https://developer.android.com/studio/build/multidex#mdex-on-l</a></p></div></aside></section><section id="execution"><h2>Execution</h2><div class="paragraph"><p>Executing selected tasks</p></div>
<div class="ulist"><ul><li><p>Incremental</p></li><li><p>Cacheable</p></li><li><p>Parallelizable</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Gradle run the requested task or tasks.</p></div>
<div class="paragraph"><p>Example: <code>gradle clean</code>, <code>gradle assembleDebug</code></p></div>
<div class="paragraph"><p>includes AndroidStudio-Sync, Android Studio uses Gradle under the hood</p></div>
<div class="paragraph"><p>To do so, it needs to run all the tasks it transitively depends on.</p></div>
<div class="paragraph"><p>Gradle makes task execution faster:</p></div>
<div class="ulist"><ul><li><p>by running task incrementally</p></li><li><p>caching task outputs</p></li><li><p>running tasks in parallel</p></li></ul></div>
<div class="paragraph"><p>You want the execution to be incremental, highly cacheable, and parallelized.</p></div>
<div class="paragraph"><p>So let&#8217;s look into each of these properties.</p></div></aside></section><section id="incrementality"><h2>Incrementality</h2><div class="paragraph"><p>Nothing changed and outputs still there?
<br />
Executed tasks should be zero!</p></div>
<aside class="notes"><div class="paragraph"><p>Gradle can run tasks incrementally.</p></div>
<div class="paragraph"><p>If the inputs of a tasks have not changed, and the outputs are still available
(because the task has been run before), the task does not need to run again.</p></div>
<div class="paragraph"><p>Example: compilation does not need to be re-run if the source code hasn&#8217;t changed.</p></div>
<div class="paragraph"><p>Incrementality is something a task <strong>opts into</strong> by defining its inputs and outputs.</p></div></aside></section><section id="non-incremental-task"><h2>Non-incremental task</h2><div class="imageblock" style=""><img src="./images/not-up-to-date-4.png" alt="non-incremental task" width="1100" height="*" /></div>
<aside class="notes"><div class="paragraph"><p>Here we see an example of a task that does not support incrementality.</p></div>
<div class="paragraph"><p>We run <code>assembleDebug</code> twice, everything is reported as up-to-date, but still the task
executes again.</p></div>
<div class="paragraph"><p>Happens because the task <strong>does not produce output</strong>, but rather prints into the console.</p></div>
<div class="ulist"><ul><li><p>no output, no incrementality</p></li><li><p>more often: changing inputs, like timestamps, version counters, git commit sha etc.</p></li></ul></div></aside></section><section id="changing-task-input"><h2>Changing task input</h2><div class="imageblock" style=""><img src="./images/changing-input-2.png" alt="changing input" width="1100" height="*" /></div>
<aside class="notes"><div class="paragraph"><p>Here is another task that re-runs on each execution.</p></div>
<div class="paragraph"><p>We see that a property <code>timestamp</code> has changed.</p></div>
<div class="paragraph"><p>If an input changes with each Gradle run, that completely destroys incrementality.</p></div>
<div class="paragraph"><p>Fabrics is doing something similar, generating a unique build Id for every build.</p></div>
<div class="paragraph"><p>If you&#8217;re a Fabrics user, make sure to disable that feature for your debug builds.</p></div>
<div class="paragraph"><p><a href="https://docs.fabric.io/android/crashlytics/build-tools.html#disable-crashlytics-for-debug-builds" class="bare">https://docs.fabric.io/android/crashlytics/build-tools.html#disable-crashlytics-for-debug-builds</a></p></div></aside></section><section id="faster-compilation"><h2>Faster Compilation</h2><div class="ulist"><ul><li><p>Modularization &#8658; Compile avoidance</p></li><li><p>Decoupled code &#8658; Faster incremental compilation</p></li><li><p>careful with annotation processing</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Gradle provides ways to make compilation faster.</p></div>
<div class="paragraph"><p>Concept of "Compile Avoidance"</p></div>
<div class="ulist"><ul><li><p>if project A depends on project B and an implementation detail in B is changed
without affecting B&#8217;s public interface, A does not need to be recompiled</p></li><li><p>Modularization enables compile avoidance</p><div class="ulist"><ul><li><p>does not work for kotlin yet: <a href="https://youtrack.jetbrains.com/issue/KT-24203" class="bare">https://youtrack.jetbrains.com/issue/KT-24203</a></p></li></ul></div></li></ul></div>
<div class="paragraph"><p>Concept of "incremental compilation"</p></div>
<div class="ulist"><ul><li><p>only compiles changed code and the code that depends on it</p></li><li><p>Suppose class A extends from class B and not other code depends on B.
If we change B, only A get re-compiled.</p></li></ul></div>
<div class="paragraph"><p>Annotation processing</p></div>
<div class="paragraph"><p>A regular annotation processor is some piece of code that gets run by the compiler.
It could do anything, it might even format your hard-drive.</p></div>
<div class="paragraph"><p>So it has to be <strong>run on any code change</strong>.</p></div>
<div class="paragraph"><p>If you need to use an annotation processor limit its usage to a sub-project if possible.</p></div>
<div class="paragraph"><p>For instance, define your room entities in a separate module and apply
the room annotation-processor only in there.</p></div></aside></section><section id="incremental-annotation-processing"><h2>Incremental Annotation processing</h2><div class="ulist"><ul><li><p>since Gradle 4.7</p></li><li><p>processors need to opt-in</p></li><li><p><code>kapt.incremental.apt = true</code> since kotlin 1.3.30</p></li></ul></div>
<div class="openblock small"><div class="content"><div class="paragraph"><p><a href="https://docs.gradle.org/current/userguide/java_plugin.html#sec:incremental_annotation_processing" class="bare">https://docs.gradle.org/current/userguide/java_plugin.html#sec:incremental_annotation_processing</a></p></div></div></div>
<aside class="notes"><div class="paragraph"><p>To address the problem of broken incremental compilation due to annotation processing
Gradle came up with a simple set of rules for processors to follow to enable incrementality.</p></div>
<div class="paragraph"><p>Each annotation processor need to explicitly declared that is follows those rules.</p></div>
<div class="paragraph"><p>For many annotation processors it has to be explicitly enabled!</p></div>
<div class="paragraph"><p>If any of the annotation processors in a project is not incremental,
incremental compilation is disabled!</p></div>
<div class="paragraph"><p>When you run annotation processing through KAPT, incremental processing needs to be opted into.
It also is only support starting from kotlin 1.3.30. You pot-in by specifying the
listed property in your <code>gradle.properties</code> file.</p></div>
<div class="paragraph"><p>Given link to docs contains a list of popular annotation processors and
the state of them supporting incremental annotation processing.</p></div></aside></section><section id="dagger"><h2>Dagger</h2><div class="title">build.gradle</div><pre class="highlight listingblock"><code data-noescape="" class="groovy language-groovy">javaCompileOptions {
  annotationProcessorOptions {
    arguments &lt;&lt; ["dagger.gradle.incremental": "true"]
  }
}</code></pre>
<aside class="notes"><div class="paragraph"><p>inside <code>android.defaultConfig</code></p></div></aside></section><section id="cacheability"><h2>Cacheability</h2><div class="paragraph"><p>Task has been run with same inputs before?
<br />
Pull its outputs from cache</p></div>
<div class="paragraph"><p><code>org.gradle.caching = true</code></p></div>
<aside class="notes"><div class="paragraph"><p>Extension on incrementality, handling the case that where the outputs have been deleted,
but can be recreated from cache entry.</p></div>
<div class="paragraph"><p>Local build cache is handy <strong>when switching between branches</strong>.</p></div>
<div class="paragraph"><p>Outputs get overridden but can be recreated from the local cache.</p></div>
<div class="paragraph"><p>Tasks need to <strong>opt-in</strong> into this mechanism.</p></div></aside></section><section id="local-cache-utilization"><h2>Local cache utilization</h2><div class="imageblock" style=""><img src="./images/build-cache-performance.png" alt="build cache performance" width="1100" height="*" /></div>
<aside class="notes"><div class="paragraph"><p>A scan after running <code>clean assembleDebug</code> twice.</p></div>
<div class="paragraph"><p>Outputs are fully pulled from cache.</p></div>
<div class="paragraph"><p>Remember: Caching needs to be enabled via <code>org.gradle.cache=true</code>, or running with <code>--build-cache</code>.</p></div></aside></section><section id="local-cache-utilization-2"><h2>Local cache utilization</h2><div class="paragraph"><p>Many tasks are cacheable</p></div>
<aside class="notes"><div class="paragraph"><p>More to come with every Android Gradle plugin update.</p></div>
<div class="paragraph"><p>For example: java unit test execution is already cached for java modules.
Coming for Android modules soon.</p></div>
<div class="paragraph"><p>If nothing has changed in a module or the modules it depends on, why re-run the tests?</p></div>
<div class="paragraph"><p>For some tasks, caching does not make sense:
For example: Jar task is not cached, it&#8217;s faster to re-execute than to pull from cache and extract again.</p></div></aside></section><section id="remote-cache"><h2>Remote cache</h2><div class="imageblock" style=""><img src="./images/build-cache.png" alt="remote cache setup" width="600" height="*" /></div>
<aside class="notes"><div class="paragraph"><p>Local caching is nice, but you actually what remote caching.</p></div>
<div class="paragraph"><p>A remote cache is a cache shared within your team or organization.</p></div>
<div class="paragraph"><p>Cache gets populated from CI builds, developers only read from it.</p></div>
<div class="paragraph"><p>Can be used side-by side with a local build cache.</p></div>
<div class="paragraph"><p>Now everything that has been build on CI becomes available from the cache!</p></div>
<div class="paragraph"><p>Tremendous speed-ups in development.</p></div>
<div class="paragraph"><p>Scenario:</p></div>
<div class="ulist"><ul><li><p>the long first build after pulling in the morning</p></li><li><p>CI has build it before, lot&#8217;s of task outputs can be pulled off the remote cache.</p></li></ul></div></aside></section><section id="remote-cache-misses"><h2>Remote Cache Misses</h2><div class="ulist"><ul><li><p>input hash changes across environments</p></li><li><p>due to non-portable inputs</p></li></ul></div>
<div class="paragraph"><p>Talk by Nelson Osacky from SoundCloud:
<br />
<a href="https://www.youtube.com/watch?v=tHe4IC0fBKg" class="bare">https://www.youtube.com/watch?v=tHe4IC0fBKg</a></p></div>
<aside class="notes"><div class="paragraph"><p>Maintaining a high cache hit rate is still some effort.</p></div>
<div class="paragraph"><p>There have been quite some tasks in the Android Gradle plugins
that broke cacheability</p></div>
<div class="paragraph"><p>But bugs get fixed with every new release of the Android Gradle plugin,
so staying up to date is important.</p></div></aside></section><section id="parallelism"><h2>Parallelism</h2><div class="ulist"><ul><li><p><code>org.gradle.parallel = true</code> or <code>--parallel</code></p></li><li><p>for decoupled modules</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Off by default, should be safe in almost all cases.</p></div>
<div class="paragraph"><p>Works best with many small, decoupled modules.</p></div>
<div class="paragraph"><p>There is no in-project parallelity.</p></div>
<div class="paragraph"><p>Gradle has separate APIs for in-project parallel execution that plugins can use.</p></div></aside></section><section id="a-non-parallel-build"><h2>A non-parallel build</h2><div class="imageblock" style=""><img src="./images/no-parallel-execution.png" alt="no parallel execution" width="1100" height="*" /></div></section><section id="a-parallel-build"><h2>A parallel build</h2><div class="imageblock" style=""><img src="./images/parallel-execution.png" alt="parallel execution" width="1100" height="*" /></div></section></section>
<section><section id="keeping-track-of-performance"><h2>Keeping Track of Performance</h2></section><section id="gradle-enterprise"><h2>Gradle Enterprise</h2><div class="ulist"><ul><li><p>all the builds of your organization</p></li><li><p>searchable</p></li><li><p>powerful dashboards</p></li><li><p>build comparisons</p></li><li><p>enterprise grade remote cache</p></li><li><p>supports Gradle and Maven</p></li><li><p>installed on premise within your organization</p></li></ul></div>
<div class="openblock small"><div class="content"><div class="paragraph"><p><a href="https://gradle.com/" class="bare">https://gradle.com/</a></p></div></div></div>
<aside class="notes"><div class="paragraph"><p>If you like build scans, imaging what you could do
when you&#8217;d collect build scans for each build run within your organization.</p></div>
<div class="paragraph"><p>"runs on my machine" problems become a lot easier to solve.
Let&#8217;s just compare the 2 belonging scans.</p></div></aside></section></section>
<section><section id="conclusion"><h2>Conclusion</h2></section><section id="takeaways"><h2>Takeaways</h2><div class="ulist"><ul><li><p>know your build</p></li><li><p>monitor and measure</p></li><li><p>avoid unnecessary configuration</p></li><li><p>re-use task outputs</p></li></ul></div></section><section id="resources"><h2>Resources</h2><div class="paragraph"><p><a href="https://docs.gradle.org" class="bare">https://docs.gradle.org</a></p></div>
<div class="paragraph"><p><a href="https://guides.gradle.org/performance/" class="bare">https://guides.gradle.org/performance/</a></p></div>
<div class="paragraph"><p><a href="https://developer.android.com/studio/build/optimize-your-build.html" class="bare">https://developer.android.com/studio/build/optimize-your-build.html</a></p></div></section></section>
<section id="thank-you"><h2>Thank you!</h2></section></div></div><script src="reveal.js/lib/js/head.min.js"></script><script src="reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
})

// See https://github.com/hakimel/reveal.js#configuration for a full list of configuration options
Reveal.initialize({
  // Display presentation control arrows
  controls: true,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: true,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: true,
  // Display the page number of the current slide
  slideNumber: 'true',
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Push each slide change to the browser history
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'linear',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
      { src: 'reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
      { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: 'reveal.js/plugin/notes/notes.js', async: true },
      
      
      
      
  ],

  

});</script><!-- this currently shows up at the wrong location in the final index.html which means the style font is not properly applied-->

<div class="footer">
</div></body></html>